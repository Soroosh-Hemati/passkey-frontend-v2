<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8" />
  <title>ØªØ³Øª Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Passkey (RSA-SHA256)</title>
  <script src="./passkey-sdk.js"></script>
  <style>
    body {
      font-family: sans-serif;
      direction: rtl;
      text-align: center;
      padding: 50px;
    }
    input {
      padding: 10px;
      width: 250px;
      border-radius: 8px;
      border: 1px solid #ccc;
      margin-bottom: 10px;
    }
    button {
      padding: 10px 20px;
      border-radius: 8px;
      border: none;
      background-color: #007bff;
      color: white;
      cursor: pointer;
      font-size: 16px;
    }
    button:hover {
      background-color: #0056b3;
    }
    pre {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 8px;
      text-align: left;
      direction: ltr;
      max-height: 300px;
      overflow: auto;
    }
  </style>
</head>
<body>

  <h2>ğŸ§© ØªØ³Øª Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Passkey (RSA-SHA256)</h2>
  <p>Ø§ÛŒÙ…ÛŒÙ„ ÛŒØ§ Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù† Ùˆ Ø±ÙˆÛŒ Â«Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…Â» Ø¨Ø²Ù†.</p>

  <input type="text" id="userId" placeholder="user@example.com" />
  <br />
  <button id="registerBtn">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Passkey</button>

  <h3>Ù†ØªÛŒØ¬Ù‡:</h3>
  <pre id="result"></pre>

  <script>
    const BASE_URL = "https://passkey-backend-xht7.onrender.com";

    async function handleRegister() {
      const resultBox = document.getElementById("result");
      resultBox.textContent = "Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª Ú©Ù„ÛŒØ¯ Ùˆ Ø«Ø¨Øª Ø¯Ø± Ø³Ø±ÙˆØ±...";

      const id = document.getElementById("userId").value.trim();
      if (!id) {
        alert("Ø´Ù†Ø§Ø³Ù‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.");
        return;
      }

      try {
        // 1ï¸âƒ£ Ø¯Ø±ÛŒØ§ÙØª challenge Ø§Ø² Ø³Ø±ÙˆØ±
        const challengeRes = await fetch(`${BASE_URL}/api/register-challenge`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ id })
        });

        if (!challengeRes.ok) {
          throw new Error("Ø¯Ø±ÛŒØ§ÙØª challenge Ø¨Ø§ Ø®Ø·Ø§ Ù…ÙˆØ§Ø¬Ù‡ Ø´Ø¯");
        }

        const options = await challengeRes.json();
        const publicKey = options.publicKey;

        // 2ï¸âƒ£ Ø§ÛŒØ¬Ø§Ø¯ credential Ø¨Ø§ WebAuthn
        const cred = await navigator.credentials.create({ publicKey });
        if (!cred) throw new Error("Ø³Ø§Ø®Øª credential Ø´Ú©Ø³Øª Ø®ÙˆØ±Ø¯");

        // 3ï¸âƒ£ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ú©Ù„ÛŒØ¯ Ø¹Ù…ÙˆÙ…ÛŒ RSA Ø§Ø² attestation
        const attestationBuffer = cred.response.attestationObject;
        const publicKeyPem = await PasskeySDK.extractRSAPublicKey(attestationBuffer);

        // 4ï¸âƒ£ Ø°Ø®ÛŒØ±Ù‡ public key Ø¯Ø± Ø³Ø±ÙˆØ±
        const saveRes = await fetch(`${BASE_URL}/api/save-key`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ id, public_key: publicKeyPem })
        });

        if (!saveRes.ok) {
          const err = await saveRes.json().catch(() => ({}));
          throw new Error(err.error || "Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ú©Ù„ÛŒØ¯ Ø¯Ø± Ø³Ø±ÙˆØ±");
        }

        resultBox.textContent = "âœ… Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù…ÙˆÙÙ‚!\n\n" + publicKeyPem;
      } catch (err) {
        console.error(err);
        resultBox.textContent = "âŒ Ø®Ø·Ø§: " + err.message;
      }
    }

    document.getElementById("registerBtn").addEventListener("click", handleRegister);
  </script>

</body>
</html>
